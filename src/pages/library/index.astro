---
import WikiLayout from '../../layouts/WikiLayout/index.astro';
import styles from './Wiki.module.css';
import { getCollection } from 'astro:content';

// Load all wiki entries
const wikiEntries = await getCollection('wiki');

function slugify(value) {
  return String(value || '')
    .trim()
    .toLowerCase()
    .replace(/&/g, 'and')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

// Group by category
const grouped = {};
for (const entry of wikiEntries) {
  const category = entry.data.category || 'Uncategorised';
  if (!grouped[category]) grouped[category] = [];
  grouped[category].push(entry);
}

// Sort entries within each category
for (const cat in grouped) {
  grouped[cat].sort((a, b) => a.data.title.localeCompare(b.data.title));
}

// Sort categories alphabetically
const sortedCategories = Object.keys(grouped).sort();

const categoryDescriptions = {
  Basics: 'Core conventions for writing and navigating the wiki.',
  Structure: 'How content is organized and what each page type is for.',
  Editing: 'Practical guidance for maintaining, revising, and classifying pages.',
  Reference: 'Indexes and overview lists for quick navigation.',
};
---

<WikiLayout posts={wikiEntries}>
  <h1>Library</h1>
  <p>Browse topics by category:</p>

  <div class={styles.categoryGrid}>
    {sortedCategories.map(category => (
      <div class={styles.categoryCard}>
        <div class={styles.categoryHeader}>
          <h2 id={`category-${slugify(category)}`}>{category}</h2>
        </div>
        {categoryDescriptions[category] && (
          <p class={styles.categoryDescription}>{categoryDescriptions[category]}</p>
        )}
        <ul>
          {grouped[category].map(entry => (
            <li>
              <a href={`/library/${entry.slug}`}>{entry.data.title}</a>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </div>
</WikiLayout>
